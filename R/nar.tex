nar <- function(g, y_offset = 0.05, size = NA, separator = FALSE){
	stopifnot("ggplot" %in% class(g))	

	# Get X axis ticks
	x_values <- ggplot_build(g)$layout$panel_params[[1]]$x.major_source

	# Get Y range
	y_range <- ggplot_build(g)$layout$panel_params[[1]]$y.range
	y_size <- y_range[2]-y_range[1]
	y_values <- ggplot_build(g)$layout$panel_params[[1]]$y.major_source
	
	# Get data from ggplot object
	d <- g$data

	# Get NAR table for the correct x ticks
	nar <- data.frame(n.risk = double(), strata = character(), x = integer(), stringsAsFactors = FALSE)
	# for(i in x_values){
	# 	tmp <- d %>% filter(ceiling(time) == i) %>% 
	# 		group_by(strata) %>%
	# 		filter(time == max(time)) %>% 
	# 		filter(n.event == min(n.event)) %>% 
	# 		ungroup() %>% 
	# 		select(n.risk, strata) %>% 
	# 		mutate(x = i)
	# 	nar <- bind_rows(tmp, nar)
	# }
	for(i in x_values){
		tmp <- d %>% filter(time <= i) %>% 
			group_by(strata) %>%
			filter(time == max(time) ) %>% 
			arrange(desc(n.risk)) %>% 
			slice(1) %>% 
			ungroup() %>% 
			select(n.risk, strata) %>% 
			mutate(x = i)
		nar <- bind_rows(tmp, nar)
	}



	# Get Y values for the NAR table
	nar$y <- as.double(NA)
	for(i in 1:length(unique(nar$strata))){
		nar[nar$strata == unique(nar$strata)[i],]$y <- y_range[1] - (i * y_offset * y_size)
	}

	# Add NAR table, and make sure that X and Y ticks are unchanged
	g <- g + geom_text(data=nar, mapping = aes(x = x, y = y, label = n.risk), show.legend = FALSE, size = size) +
		scale_y_continuous(breaks = y_values)

	# Add separator if desired
	if(separator == TRUE){
		g <- g + geom_hline(yintercept = y_range[1], lwd = 0.20, color = "grey70")

	}

	return(g)
}



g + geom_text(data=nar, mapping = aes(x = x, y = y, label = n.risk), show.legend = FALSE)
